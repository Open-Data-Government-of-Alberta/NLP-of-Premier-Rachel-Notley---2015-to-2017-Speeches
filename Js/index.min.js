// Copyright (c) 2018 Michael Omondi Otyeno
//
// This software is released under the MIT License.
// https://opensource.org/licenses/MIT
var log=console.log,speechesFile=["Data/speeches-data.json"],speechPromise=promise(speechesFile,"json"),pos=["nouns","verbs","adverbs","adjectives","contractions","dates","people","acronyms","organizations","places","values","quotations","terms","topics","clauses","possessives"].reverse(),tree=echarts.init(document.getElementById("tree")),treeOption={tooltip:{trigger:"item",triggerOn:"mousemove"},series:[{type:"tree",top:"0%",left:"7.5%",bottom:"0%",right:"8.5%",symbolize:7,label:{normal:{position:"left",verticalAlign:"middle",align:"right",fontSize:10,formatter:function(e){return void 0!=e.value?e.name+" "+e.value:""+e.name}}},leaves:{label:{normal:{position:"right",verticalAlign:"middle",align:"left"}}},expandAndCollapse:!1}]},wordCloud=echarts.init(document.getElementById("word-cloud")),wordOption={tooltip:{trigger:"item",triggerOn:"mousemove"},series:[{type:"wordCloud",left:"center",top:"center",width:"100%",height:"100%",right:null,bottom:null,sizeRange:[9.5,57.5],rotationRange:[-90,90],rotationStep:10,gridSize:2,shape:"pentagon",drawOutOfBound:!1,textStyle:{emphasis:{color:"red"}}}]},div=d3.select("#detail").append("div").attr("id","tooltip").style("opacity",0);function PromiseWrapper(e,t){return new Promise(function(n){d3[t](e,function(e){n(e)})})}function promise(e,t){return e.map(function(e){return PromiseWrapper(e,t)})}function speechesProcessor(e){var t=e[0].data,n=function(e,t,n){return d3.map(e,function(e){return e[t]}).get(n)};function o(e){var o=t[e].speeches,i=promise(o.map(function(e){return e["Text Path"]}),"text");Promise.all(i).then(function(e){return function(e){function t(t){var r,i,l=nlp(e[t]),c=o[t],u=c["WordCloud Data"],a=["Date","Location","Main Message"],d=function(e){return nlp(e).toTitleCase().out("text")};function p(e){return l[e]().out("topk")}treeOption.series[0].data=[c["Tree Data"]],wordOption.series[0].data=u,wordOption.tooltip.formatter=function(e){return e.name+" : "+e.value+"<br> \n                                                                   tags : "+n(u,"name",e.name).tags},wordCloud.setOption(wordOption),r="selct-opt",i=pos,document.getElementById(r).innerHTML="<select>\n                        "+i.reduce(function(e,t){return'<option value="'+t+'">'+d(t)+" : "+p(t).length+"</option>"+e},"")+"</select>",s(p("nouns")),tree.setOption(treeOption),document.getElementById("speech-link").href=c.Url,d3.select("#selct-opt select").on("change.pos",function(){var e=d3.select(this).node().value;s(p(e))}),d3.select("div#sticky").on("mouseover.tooltip",function(){div.transition().duration(350).style("opacity",.7),div.html(a.reduce(function(e,t){return e+(t+": ")+c[t]+"<br>"},"")+pos.map(function(e){return e}).reverse().reduce(function(e,t,n,o){return n!=pos.length-1?e+(d(t)+": ")+p(t).length+"<br>":e+(d(t)+": ")+p(t).length},"")).style("top",d3.event.pageY+15+"px")}).on("mouseout.tooltip",function(){div.transition().duration(350).style("opacity",0)})}t(0),r(o,"Title","Terms Value",t)}(e)})}function r(e,t,n,o){var r,i;document.getElementById(t+"-opts").innerHTML=(r=t,e.map(function(e){return'<option value="'+e[r]+'">'+e[r]+"</option>"}).reduce(function(e,t){return e+t},"")),Object.values(document.querySelectorAll("#"+t+"-opts option")).forEach(function(t,o){return t.innerHTML+=": "+e[o][n]}),i=o,d3.select("select#"+t+"-opts").on("change."+t,function(){var n=d3.select(this).node().value,o=d3.map(e,function(e){return e[t]}).get(n),r=e.indexOf(o);i(r)})}function i(e){return d3.range(0,e).map(function(e){return"&nbsp"}).reduce(function(e,t){return e+t},"")}function s(e){var t=e.length,n=document.getElementById("pos-table");return n.innerHTML=e.reduce(function(e,t){return e+='<tr>\n                <td style="color: #46468B;">'+(t.normal||t.text||"")+i(4)+'</td>\n                <td style="color: #7A7A8B;">'+(t.count||"")+i(4)+'</td>\n                <td style="color: #B7B7D1;">'+t.percent+"%</td>\n            </tr>"},""),0==t&&(n.innerHTML="----None Exist----"),n}o(0),r(t,"year","Total Speeches",o)}function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("myBtn").style.display="block":document.getElementById("myBtn").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}Promise.all(speechPromise).then(function(e){return speechesProcessor(e)}),window.onscroll=function(){scrollFunction()};